{% extends 'base.html' %}
{% load crispy_forms_tags %}
{% block content %}
<div class="container my-4" style="max-width: 720px;">
  <h4 class="fw-bold border-bottom pb-2 mb-4 text-primary">ğŸ“ ìƒˆ í€´ì¦ˆ ë“±ë¡</h4>

  <form method="post">
    {% csrf_token %}
    {{ form|crispy }}

    <!-- âœ… ê·¸ë¦¼ ë¯¸ë¦¬ë³´ê¸° -->
    <div id="drawingPreviewContainer" class="mt-3 text-center" style="display:none;">
      <h6 class="text-secondary mb-2">ğŸ–¼ï¸ ì„ íƒí•œ ê·¸ë¦¼ ë¯¸ë¦¬ë³´ê¸°</h6>
      <img id="drawingPreview" src="" alt="ê·¸ë¦¼ ë¯¸ë¦¬ë³´ê¸°"
           class="img-fluid rounded shadow-sm border" style="max-height:250px;">
    </div>

    <div class="d-flex justify-content-end mt-4">
      <a href="{% url 'quiz:index' %}" class="btn btn-outline-secondary me-2">ì·¨ì†Œ</a>
      <button type="submit" class="btn btn-primary">ì €ì¥í•˜ê¸°</button>
    </div>
  </form>
</div>

<!-- JS ì½”ë“œ -->
<script>
document.addEventListener('DOMContentLoaded', () => {
  const select = document.getElementById('id_drawing'); // ê·¸ë¦¼ ì„ íƒ select
  const previewContainer = document.getElementById('drawingPreviewContainer');
  const previewImg = document.getElementById('drawingPreview');
  const answerInput = document.getElementById('id_correct_answer'); // ì •ë‹µ ì…ë ¥ input

  if (!select) return;

  select.addEventListener('change', async () => {
    const drawingId = select.value;

    // 1. ê·¸ë¦¼ ë¯¸ë¦¬ë³´ê¸°
    if (drawingId) {
      const imgUrl = `/static/assets/images/drawing/${drawingId}.png`;
      previewImg.src = imgUrl;
      previewContainer.style.display = 'block';
    } else {
      previewContainer.style.display = 'none';
      previewImg.src = '';
    }

    // 2. ì„œë²„ì—ì„œ subject ê°€ì ¸ì˜¤ê¸°
    if (drawingId && answerInput) {
      try {
        const response = await fetch(`/drawing/get_subject/${drawingId}/`);
        if (response.ok) {
          const data = await response.json();
          answerInput.value = data.subject || '';
        } else {
          console.error('Failed to fetch subject');
        }
      } catch (err) {
        console.error('Error fetching subject:', err);
      }
    } else if (answerInput) {
      answerInput.value = '';
    }
  });
});
</script>
{% endblock %}
